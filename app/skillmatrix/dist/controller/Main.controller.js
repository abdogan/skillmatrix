sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","skillmatrix/skillmatrix/formatter/CapacityFormatter","sap/ui/core/Fragment"],(e,t,o,i,n)=>{"use strict";return e.extend("skillmatrix.skillmatrix.controller.Main",{capacityFormatter:i,onInit(){const e=new t({DateFilter:{dateFrom:null,dateTo:null}});this.getView().setModel(e,"dateFilterModel");this.getOwnerComponent().getRouter().getRoute("RouteMain").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched(){const e=this.byId("gridList"),t=e.getBinding("items");if(t){t.refresh()}},getText(e,t){return this.getView().getModel("i18n").getResourceBundle().getText(e,t)},onDateRangeChange(e){let t=e.getSource(),o=t.getDateValue(),i=t.getSecondDateValue();if(!o||!i){return}const n=o.getDay(),s=n===0?-6:1-n;o=new Date(o);o.setDate(o.getDate()+s);const r=i.getDay(),a=r===0?0:7-r;i=new Date(i);i.setDate(i.getDate()+a);t.setDateValue(o);t.setSecondDateValue(i);const l=this.getView().getModel("dateFilterModel");l.setProperty("/DateFilter/dateFrom",o);l.setProperty("/DateFilter/dateTo",i)},onFilterBarSearch(){const e=this.byId("gridList"),i=e.getBinding("items");const n=this.byId("skillsFilter").getSelectedKeys(),s=this.byId("membersFilter").getSelectedKeys();const r=[];if(n.length){const e=n.map(e=>new sap.ui.model.Filter({path:"TO_MEMBER_SKILLS",operator:sap.ui.model.FilterOperator.Any,variable:"member",condition:new sap.ui.model.Filter("member/SKILL",sap.ui.model.FilterOperator.EQ,e)}));r.push(new sap.ui.model.Filter({filters:e,and:true}))}if(s.length){const e=s.map(e=>new o("KID","EQ",e));r.push(new o({filters:e,and:false}))}console.log("Selected skill keys:",this.byId("skillsFilter").getSelectedKeys());const a=this.getView().getModel("dateFilterModel");const l=a.getProperty("/DateFilter/dateFrom");const c=a.getProperty("/DateFilter/dateTo");console.log("Filter range from:",l,"to:",c);if(!l||!c){i.filter(r.length?new o({filters:r,and:true}):[]);return}const d=e=>{const t=e.split(" - ")[0];const[o,i,n]=t.split(".");const s=parseInt(n,10)<50?2e3+parseInt(n):1900+parseInt(n);return new Date(`${s}-${i}-${o}`)};const g=i.getCurrentContexts().map(e=>e.getObject());const h={};g.forEach(e=>{const t=e.TO_CAPACITY||[];const o=t.filter(e=>{const t=d(e.DATE_RANGE);return t>=l&&t<=c});if(!o.length)return;const i=o.reduce((e,t)=>e+t.CAPACITY,0)/o.length;const n=1-i;const s=(n*100).toFixed(2);e.availabilityPercent=`${s}%`;console.log("Member enriched:",e);const r=t.map(e=>({date:d(e.DATE_RANGE),cap:e.CAPACITY,range:e.DATE_RANGE})).filter(e=>e.date>c).sort((e,t)=>e.date-t.date);const a=r.find(e=>e.cap===0);e.nextAvailability=a?a.range:"-";console.log(`Member ${e.KID} : Availability: ${s}%, Next Free: ${e.nextAvailability}`);h[e.KID]={availabilityPercent:`${s}%`,nextAvailability:e.nextAvailability}});const p=new t(h);this.getView().setModel(p,"availabilityModel");i.filter(r.length?new o({filters:r,and:true}):[])},onClearFilters(){const e=this.byId("skillsFilter"),t=this.byId("membersFilter"),o=this.byId("dateRangeFilter");if(e)e.setSelectedKeys([]);if(t)t.setSelectedKeys([]);if(o){o.setDateValue(null);o.setSecondDateValue(null)}this.onFilterBarSearch();sap.m.MessageToast.show(this.getText("filtersCleared"))},onSelectionChange(){this.onFilterBarSearch()},onEditEmployeeDataPress(e){const t=e.getSource().getBindingContext("catalogModel"),o=t.getProperty("KID");const i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("RouteEditEmployeeData",{KID:o})},onMorePress(e){const t=e.getSource();const o=t.getBindingContext("catalogModel");if(!this._pActionSheet){this._pActionSheet=this.loadFragment({name:"skillmatrix.skillmatrix.view.ActionSheet",id:"actionSheet"}).then(e=>{e.setModel(this.getView().getModel("i18n"),"i18n");this.getView().addDependent(e);return e})}this._pActionSheet.then(e=>{e.setBindingContext(o,"catalogModel");e.openBy(t)})},onOpenWeekPicker(e){const t=this.getView();const o=this.byId("weeklyInput");if(!this._pPopover){this._pPopover=n.load({id:t.getId(),name:"skillmatrix.skillmatrix.view.WeekPicker",controller:this}).then(function(e){t.addDependent(e);return e})}this._pPopover.then(function(e){e.openBy(o)})},onDetailsPress(e){const t=e.getSource().getBindingContext("catalogModel"),o=t.getProperty("KID");const i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("RouteEmployeeDetails",{KID:o})},onDeletePress(e){const t=e.getSource().getBindingContext("catalogModel");const o=this.getView().getModel("catalogModel");if(!t){console.warn(this.getText("DeleteNoContext"));return}sap.m.MessageBox.confirm(this.getText("DeleteConfirmation"),{onClose:e=>{if(e==="OK"){t.delete();o.submitBatch("teamMembersGroup").then(()=>{sap.m.MessageToast.show(this.getText("DeleteSuccessText"));o.refresh()}).catch(e=>{sap.m.MessageBox.error(this.getText("DeleteFailedText"));console.error(this.getText("DeleteConsoleErrorText"),e)})}}})}})});
//# sourceMappingURL=Main.controller.js.map